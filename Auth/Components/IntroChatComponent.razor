@page "/chatroom"

<MudText Typo="Typo.h3">Welcome to Ovidiu's Chat App</MudText>
<AuthorizeView>
    <Authorized>
        <MudText Typo="Typo.h4">Please Choose the Chat You want to join</MudText>
        <MudGrid>
            <MudItem Style="padding-top: 30px;">
                <MudPaper Width="300px" Height="500px">
                    <MudList Clickable="true">
                        <MudListSubheader>
                            <MudText Typo="Typo.h6"><b>Chats You are Part Of</b></MudText>
                        </MudListSubheader>
                        @foreach (var chat in Chats)
                                {
                        <MudListItem @onclick="() => RedirectToDisplay(chat)" Icon="@Icons.Material.Filled.Send">
                            @chat
                        </MudListItem>
                        }
                    </MudList>
                </MudPaper>
            </MudItem>
            <MudItem Style="padding-top: 100px;">
                <MudPaper Width="240px">
                    <MudCard>
                        <MudCardContent>
                            <MudCardHeader>
                                <CardHeaderContent>
                                    <MudText Typo="Typo.h6" Style="align: left;">Create a new Chat</MudText>
                                </CardHeaderContent>
                            </MudCardHeader>
                            <MudForm>
                                <MudTextField @bind-Value="nameToRdir" T="string" Label="ChatName" Required="true"
                                    RequiredError="Chat Name is required!" />
                            </MudForm>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto"
                                @onclick="() => CreateChat(nameToRdir)">Create Chat</MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </Authorized>
    <NotAuthorized>
        <MudText Typo="Typo.h2" Style="align: center;">Please Login First</MudText>
    </NotAuthorized>
</AuthorizeView>



@code {
    public string username;
    private List<string> Chats = new List<string>();
    public string nameToRdir;
    private bool toRedirect = false;
    protected override async Task OnInitializedAsync()
    {
        if (_httpContextAccessor.HttpContext.User.Identity.IsAuthenticated)
        {
            username = _httpContextAccessor.HttpContext.User.FindFirst(ClaimTypes.Name).Value;
            Chats = chatService.GetChats();
            foreach (var name in Chats) System.Console.WriteLine(name);
        }
    }
    private void RedirectToDisplay(string chatName)
    {
        nameToRdir = chatName;
        navigationManager.NavigateTo("/chatroom/" + chatName);
    }
    private void CreateChat(string chatName)
    {
        nameToRdir = chatService.CreateChat(chatName, username);
        RedirectToDisplay(chatName);
    }
}
