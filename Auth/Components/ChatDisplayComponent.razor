@page "/chatroom/{chatName}"

@if(_messages == null)
{
    <MudText>Loading</MudText>
}
else
{
    <AuthorizeView>
        <Authorized>
            <div class="alert alert-secondary mt-4" role="alert">
                <span class="oi oi-person mr-2" aria-hidden="true"></span>
                <span>You are connected as <b>@_username</b></span>
                <button class="btn btn-sm btn-warning ml-md-auto" @onclick="@DisconnectAsync">Disconnect</button>
            </div>
            <div id="scrollbox">
                @foreach (var item in _messages)
                {
                    @if (item.IsNotice)
                    {
                        <div class="alert alert-info">@item.Body</div>
                    }
                    else
                    {
                        <div class="@item.CSS">
                            <div class="user">@item.Username</div>
                            <div class="msg">@item.Body</div>
                        </div>
                    }
                }
                <hr />
                <textarea class="input-lg" placeholder="enter your comment..." @bind="@_newMessage"></textarea>
                <button class="btn btn-default" @onclick="@(() => SendAsync(_newMessage))">Send</button>
            </div>
        </Authorized>
        <NotAuthorized>
            <h3>Please Login First</h3>
        </NotAuthorized>
    </AuthorizeView>
}


@code {
    [Parameter]
    public string chatName {get; set;}
    public List<MessageModel> _messages { get; set; }
    private string _username;
    private string _newMessage; 
    private string _hubUrl;
    private HubConnection _hubConnection;
    private int state;
    protected override async Task OnInitializedAsync()
    {
        
            _username = _httpContextAccessor.HttpContext.User.FindFirst(ClaimTypes.Name).Value;
            _messages = messageService.GetMessages(_username, chatName);
            state = chatService.getState(chatName, _username);
            await Task.Delay(1);

            string baseUrl = navigationManager.BaseUri;

            _hubUrl = baseUrl.TrimEnd('/') + BlazorChatSampleHub.HubUrl;

            _hubConnection = new HubConnectionBuilder()
                .WithUrl(_hubUrl)
                .Build();

            _hubConnection.On<string, string>("Broadcast", BroadcastMessage);

            await _hubConnection.StartAsync();
            if(state == 0)
            {
                chatService.addOrRemove(chatName, _username, "1");
                await SendAsync($"[Notice] {_username} joined chat room.");
            }
                
    }

    private void BroadcastMessage(string name, string message)
    {
        bool isMine = name.Equals(_username, StringComparison.OrdinalIgnoreCase);

        _messages.Add(new MessageModel(name, message, isMine));

        StateHasChanged();
    }

    private async Task DisconnectAsync()
    {
        chatService.addOrRemove(chatName, _username, "0");
        await SendAsync($"[Notice] {_username} left chat room.");

        await _hubConnection.StopAsync();
        await _hubConnection.DisposeAsync();

        _hubConnection = null;
        navigationManager.NavigateTo("/");
    }

    private async Task SendAsync(string message)
    {
        if (!string.IsNullOrWhiteSpace(message))
        {
            await _hubConnection.SendAsync("Broadcast", _username, message);
            messageService.AddMessage(new MessageModel(_username, message, true), chatName);
            _newMessage = string.Empty;
        }
    }

}
